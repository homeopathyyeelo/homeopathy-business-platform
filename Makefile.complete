# Complete Makefile for Homeopathy Business Platform
# All services: Next.js, NestJS, Express, Fastify, Golang, Python
# Infrastructure: Kafka, Zookeeper, PostgreSQL, Redis, MinIO, GraphQL

.PHONY: help start stop restart logs status clean build test

# Default target
.DEFAULT_GOAL := help

# Colors
BLUE := \033[0;34m
GREEN := \033[0;32m
YELLOW := \033[1;33m
RED := \033[0;31m
NC := \033[0m # No Color

help: ## Show this help message
	@echo "$(BLUE)Homeopathy Business Platform - Complete Setup$(NC)"
	@echo "================================================"
	@echo ""
	@echo "$(GREEN)Available commands:$(NC)"
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | awk 'BEGIN {FS = ":.*?## "}; {printf "  $(YELLOW)%-20s$(NC) %s\n", $$1, $$2}'
	@echo ""

# ==================== MAIN COMMANDS ====================

start: ## Start all services
	@echo "$(BLUE)ğŸš€ Starting all services...$(NC)"
	@./START-ALL-SERVICES.sh

stop: ## Stop all services
	@echo "$(YELLOW)â¹ï¸  Stopping all services...$(NC)"
	@docker-compose -f docker-compose.master.yml down

restart: ## Restart all services
	@echo "$(YELLOW)ğŸ”„ Restarting all services...$(NC)"
	@make stop
	@make start

clean: ## Stop and remove all containers, volumes, and networks
	@echo "$(RED)ğŸ§¹ Cleaning up everything...$(NC)"
	@docker-compose -f docker-compose.master.yml down -v --remove-orphans
	@docker system prune -f

# ==================== SERVICE MANAGEMENT ====================

start-infra: ## Start only infrastructure (DB, Redis, Kafka)
	@echo "$(BLUE)ğŸ—ï¸  Starting infrastructure...$(NC)"
	@docker-compose -f docker-compose.master.yml up -d zookeeper kafka postgres redis minio

start-backend: ## Start only backend services
	@echo "$(BLUE)ğŸ”§ Starting backend services...$(NC)"
	@docker-compose -f docker-compose.master.yml up -d api-nest api-fastify api-express api-golang ai-service

start-frontend: ## Start only frontend
	@echo "$(BLUE)ğŸŒ Starting frontend...$(NC)"
	@docker-compose -f docker-compose.master.yml up -d nextjs-app

start-gateways: ## Start API and GraphQL gateways
	@echo "$(BLUE)ğŸŒ‰ Starting gateways...$(NC)"
	@docker-compose -f docker-compose.master.yml up -d graphql-gateway api-gateway

start-workers: ## Start worker services
	@echo "$(BLUE)âš™ï¸  Starting workers...$(NC)"
	@docker-compose -f docker-compose.master.yml up -d outbox-worker worker-golang

# ==================== LOGS ====================

logs: ## Show logs for all services
	@docker-compose -f docker-compose.master.yml logs -f

logs-nest: ## Show NestJS API logs
	@docker-compose -f docker-compose.master.yml logs -f api-nest

logs-fastify: ## Show Fastify API logs
	@docker-compose -f docker-compose.master.yml logs -f api-fastify

logs-express: ## Show Express API logs
	@docker-compose -f docker-compose.master.yml logs -f api-express

logs-golang: ## Show Golang API logs
	@docker-compose -f docker-compose.master.yml logs -f api-golang

logs-ai: ## Show Python AI service logs
	@docker-compose -f docker-compose.master.yml logs -f ai-service

logs-graphql: ## Show GraphQL gateway logs
	@docker-compose -f docker-compose.master.yml logs -f graphql-gateway

logs-kafka: ## Show Kafka logs
	@docker-compose -f docker-compose.master.yml logs -f kafka

logs-postgres: ## Show PostgreSQL logs
	@docker-compose -f docker-compose.master.yml logs -f postgres

# ==================== STATUS ====================

status: ## Show status of all services
	@echo "$(BLUE)ğŸ“Š Service Status:$(NC)"
	@docker-compose -f docker-compose.master.yml ps

health: ## Check health of all services
	@echo "$(BLUE)ğŸ¥ Health Checks:$(NC)"
	@echo ""
	@echo "$(YELLOW)NestJS API:$(NC)"
	@curl -s http://localhost:3001/health | jq . || echo "$(RED)Not responding$(NC)"
	@echo ""
	@echo "$(YELLOW)Fastify API:$(NC)"
	@curl -s http://localhost:3002/health | jq . || echo "$(RED)Not responding$(NC)"
	@echo ""
	@echo "$(YELLOW)Express API:$(NC)"
	@curl -s http://localhost:3003/health | jq . || echo "$(RED)Not responding$(NC)"
	@echo ""
	@echo "$(YELLOW)Python AI Service:$(NC)"
	@curl -s http://localhost:8001/health | jq . || echo "$(RED)Not responding$(NC)"
	@echo ""

# ==================== DATABASE ====================

db-generate: ## Generate Prisma client
	@echo "$(BLUE)ğŸ”§ Generating Prisma client...$(NC)"
	@npm run db:generate

db-migrate: ## Run database migrations
	@echo "$(BLUE)ğŸ—„ï¸  Running migrations...$(NC)"
	@npm run db:migrate

db-migrate-deploy: ## Deploy migrations (production)
	@echo "$(BLUE)ğŸš€ Deploying migrations...$(NC)"
	@npm run db:migrate:deploy

db-seed: ## Seed database
	@echo "$(BLUE)ğŸŒ± Seeding database...$(NC)"
	@npm run db:seed

db-reset: ## Reset database (WARNING: deletes all data)
	@echo "$(RED)âš ï¸  Resetting database...$(NC)"
	@docker-compose -f docker-compose.master.yml exec postgres psql -U postgres -c "DROP DATABASE IF EXISTS yeelo_homeopathy;"
	@docker-compose -f docker-compose.master.yml exec postgres psql -U postgres -c "CREATE DATABASE yeelo_homeopathy;"
	@make db-migrate-deploy
	@make db-seed

db-shell: ## Access PostgreSQL shell
	@docker-compose -f docker-compose.master.yml exec postgres psql -U postgres -d yeelo_homeopathy

# ==================== KAFKA ====================

kafka-topics: ## List Kafka topics
	@docker-compose -f docker-compose.master.yml exec kafka kafka-topics --list --bootstrap-server localhost:9092

kafka-create-topic: ## Create a Kafka topic (usage: make kafka-create-topic TOPIC=my-topic)
	@docker-compose -f docker-compose.master.yml exec kafka kafka-topics --create --topic $(TOPIC) --bootstrap-server localhost:9092 --partitions 3 --replication-factor 1

kafka-consume: ## Consume from a topic (usage: make kafka-consume TOPIC=orders)
	@docker-compose -f docker-compose.master.yml exec kafka kafka-console-consumer --topic $(TOPIC) --from-beginning --bootstrap-server localhost:9092

kafka-produce: ## Produce to a topic (usage: make kafka-produce TOPIC=orders)
	@docker-compose -f docker-compose.master.yml exec kafka kafka-console-producer --topic $(TOPIC) --bootstrap-server localhost:9092

# ==================== REDIS ====================

redis-cli: ## Access Redis CLI
	@docker-compose -f docker-compose.master.yml exec redis redis-cli

redis-monitor: ## Monitor Redis commands
	@docker-compose -f docker-compose.master.yml exec redis redis-cli MONITOR

redis-keys: ## Show all Redis keys
	@docker-compose -f docker-compose.master.yml exec redis redis-cli KEYS '*'

redis-flush: ## Flush all Redis data (WARNING: deletes all cache)
	@echo "$(RED)âš ï¸  Flushing Redis...$(NC)"
	@docker-compose -f docker-compose.master.yml exec redis redis-cli FLUSHALL

# ==================== BUILD ====================

build: ## Build all services
	@echo "$(BLUE)ğŸ”¨ Building all services...$(NC)"
	@docker-compose -f docker-compose.master.yml build

build-nest: ## Build NestJS service
	@docker-compose -f docker-compose.master.yml build api-nest

build-fastify: ## Build Fastify service
	@docker-compose -f docker-compose.master.yml build api-fastify

build-express: ## Build Express service
	@docker-compose -f docker-compose.master.yml build api-express

build-golang: ## Build Golang service
	@docker-compose -f docker-compose.master.yml build api-golang

build-ai: ## Build Python AI service
	@docker-compose -f docker-compose.master.yml build ai-service

build-frontend: ## Build Next.js frontend
	@docker-compose -f docker-compose.master.yml build nextjs-app

# ==================== TESTING ====================

test: ## Run all tests
	@echo "$(BLUE)ğŸ§ª Running tests...$(NC)"
	@npm run test

test-e2e: ## Run E2E tests
	@npm run test:e2e

test-load: ## Run load tests with k6
	@k6 run k6/load-test.js

# ==================== DEVELOPMENT ====================

dev-app: ## Start Next.js in development mode (local)
	@npm run dev:app

dev-nest: ## Start NestJS in development mode (local)
	@cd services/api-nest && npm run start:dev

dev-ai: ## Start Python AI service in development mode (local)
	@cd services/ai-service && uvicorn src.main:app --reload

# ==================== MONITORING ====================

open-kafka-ui: ## Open Kafka UI in browser
	@open http://localhost:8080 || xdg-open http://localhost:8080

open-graphql: ## Open GraphQL Playground in browser
	@open http://localhost:4000 || xdg-open http://localhost:4000

open-swagger-nest: ## Open NestJS Swagger in browser
	@open http://localhost:3001/api || xdg-open http://localhost:3001/api

open-swagger-fastify: ## Open Fastify Swagger in browser
	@open http://localhost:3002/documentation || xdg-open http://localhost:3002/documentation

open-swagger-express: ## Open Express Swagger in browser
	@open http://localhost:3003/api-docs || xdg-open http://localhost:3003/api-docs

open-swagger-ai: ## Open Python AI Swagger in browser
	@open http://localhost:8001/docs || xdg-open http://localhost:8001/docs

open-minio: ## Open MinIO console in browser
	@open http://localhost:9001 || xdg-open http://localhost:9001

open-app: ## Open Next.js app in browser
	@open http://localhost:3000 || xdg-open http://localhost:3000

open-all: ## Open all UIs in browser
	@make open-app
	@make open-graphql
	@make open-kafka-ui
	@make open-swagger-nest
	@make open-swagger-ai

# ==================== UTILITIES ====================

install: ## Install all dependencies
	@echo "$(BLUE)ğŸ“¦ Installing dependencies...$(NC)"
	@npm install

update: ## Update all dependencies
	@echo "$(BLUE)ğŸ”„ Updating dependencies...$(NC)"
	@npm update

lint: ## Run linter
	@npm run lint

format: ## Format code
	@npm run format

# ==================== QUICK ACTIONS ====================

quick-start: install db-generate start ## Quick start: install, generate, and start everything

full-reset: clean install db-generate start db-seed ## Full reset: clean, install, and start fresh

# ==================== INFO ====================

info: ## Show all service URLs
	@echo "$(BLUE)ğŸ“‹ Service URLs:$(NC)"
	@echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
	@echo ""
	@echo "$(GREEN)ğŸŒ Frontend:$(NC)"
	@echo "   Next.js App:           http://localhost:3000"
	@echo ""
	@echo "$(GREEN)ğŸ”Œ Backend APIs:$(NC)"
	@echo "   NestJS API:            http://localhost:3001"
	@echo "   NestJS Swagger:        http://localhost:3001/api"
	@echo "   Fastify API:           http://localhost:3002"
	@echo "   Fastify Swagger:       http://localhost:3002/documentation"
	@echo "   Express API:           http://localhost:3003"
	@echo "   Express Swagger:       http://localhost:3003/api-docs"
	@echo "   Golang API:            http://localhost:3005"
	@echo "   Python AI Service:     http://localhost:8001"
	@echo "   Python Swagger:        http://localhost:8001/docs"
	@echo ""
	@echo "$(GREEN)ğŸŒ‰ Gateways:$(NC)"
	@echo "   GraphQL Gateway:       http://localhost:4000/graphql"
	@echo "   API Gateway:           http://localhost:5000"
	@echo ""
	@echo "$(GREEN)ğŸ—„ï¸  Infrastructure:$(NC)"
	@echo "   PostgreSQL:            localhost:5433"
	@echo "   Redis:                 localhost:6380"
	@echo "   Kafka:                 localhost:9092"
	@echo "   Zookeeper:             localhost:2181"
	@echo "   MinIO Console:         http://localhost:9001"
	@echo ""
	@echo "$(GREEN)ğŸ“Š Monitoring:$(NC)"
	@echo "   Kafka UI:              http://localhost:8080"
	@echo "   Schema Registry:       http://localhost:8081"
	@echo ""
	@echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
