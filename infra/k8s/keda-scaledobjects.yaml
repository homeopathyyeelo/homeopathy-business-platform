# KEDA ScaledObjects for Event-Driven Autoscaling
# Learning Notes:
# - Scales services based on Kafka lag, HTTP requests, and custom metrics
# - Implements different scaling strategies per service type
# - Includes scale-to-zero for cost optimization
# - Configures proper scaling behavior and cooldown periods

apiVersion: keda.sh/v1alpha1
kind: ScaledObject
metadata:
  name: api-gateway-scaler
  namespace: yeelo-platform
spec:
  scaleTargetRef:
    name: api-gateway
  minReplicaCount: 3
  maxReplicaCount: 50
  pollingInterval: 15
  cooldownPeriod: 60
  idleReplicaCount: 3
  
  triggers:
  # Scale based on HTTP request rate
  - type: prometheus
    metadata:
      serverAddress: http://prometheus-kube-prometheus-prometheus.monitoring:9090
      metricName: http_requests_per_second
      threshold: '100'
      query: sum(rate(http_requests_total{job="api-gateway"}[1m]))
  
  # Scale based on CPU utilization
  - type: cpu
    metadata:
      type: Utilization
      value: '70'

---
apiVersion: keda.sh/v1alpha1
kind: ScaledObject
metadata:
  name: campaigns-service-scaler
  namespace: yeelo-platform
spec:
  scaleTargetRef:
    name: campaigns-service
  minReplicaCount: 2
  maxReplicaCount: 30
  pollingInterval: 10
  cooldownPeriod: 120
  
  triggers:
  # Scale based on Kafka lag for campaign events
  - type: kafka
    metadata:
      bootstrapServers: kafka:9092
      topic: campaigns
      consumerGroup: campaigns-service
      lagThreshold: '500'
      offsetResetPolicy: latest
  
  # Scale based on pending campaigns in database
  - type: postgresql
    metadata:
      connectionFromEnv: DATABASE_URL
      query: "SELECT COUNT(*) FROM campaigns WHERE status = 'pending'"
      targetQueryValue: '10'

---
apiVersion: keda.sh/v1alpha1
kind: ScaledObject
metadata:
  name: orders-service-scaler
  namespace: yeelo-platform
spec:
  scaleTargetRef:
    name: orders-service
  minReplicaCount: 2
  maxReplicaCount: 25
  pollingInterval: 15
  cooldownPeriod: 90
  
  triggers:
  # Scale based on order processing queue
  - type: kafka
    metadata:
      bootstrapServers: kafka:9092
      topic: orders
      consumerGroup: orders-service
      lagThreshold: '1000'
  
  # Scale based on active orders
  - type: prometheus
    metadata:
      serverAddress: http://prometheus-kube-prometheus-prometheus.monitoring:9090
      metricName: active_orders_count
      threshold: '100'
      query: sum(orders_active_total)

---
apiVersion: keda.sh/v1alpha1
kind: ScaledObject
metadata:
  name: ai-service-scaler
  namespace: yeelo-platform
spec:
  scaleTargetRef:
    name: ai-service
  minReplicaCount: 1
  maxReplicaCount: 15
  pollingInterval: 30
  cooldownPeriod: 300  # Longer cooldown for expensive AI operations
  idleReplicaCount: 0  # Scale to zero when idle
  
  triggers:
  # Scale based on AI request queue
  - type: kafka
    metadata:
      bootstrapServers: kafka:9092
      topic: ai-requests
      consumerGroup: ai-service
      lagThreshold: '50'
  
  # Scale based on request rate
  - type: prometheus
    metadata:
      serverAddress: http://prometheus-kube-prometheus-prometheus.monitoring:9090
      metricName: ai_requests_per_minute
      threshold: '10'
      query: sum(rate(ai_requests_total[1m])) * 60

---
apiVersion: keda.sh/v1alpha1
kind: ScaledObject
metadata:
  name: worker-golang-scaler
  namespace: yeelo-platform
spec:
  scaleTargetRef:
    name: worker-golang
  minReplicaCount: 2
  maxReplicaCount: 50
  pollingInterval: 10
  cooldownPeriod: 60
  
  triggers:
  # Scale based on multiple Kafka topics
  - type: kafka
    metadata:
      bootstrapServers: kafka:9092
      topic: orders
      consumerGroup: yeelo-worker-golang
      lagThreshold: '2000'
  
  - type: kafka
    metadata:
      bootstrapServers: kafka:9092
      topic: campaigns
      consumerGroup: yeelo-worker-golang
      lagThreshold: '1000'
  
  - type: kafka
    metadata:
      bootstrapServers: kafka:9092
      topic: analytics
      consumerGroup: yeelo-worker-golang
      lagThreshold: '5000'

---
# Custom ScaledObject for notification service based on message queue
apiVersion: keda.sh/v1alpha1
kind: ScaledObject
metadata:
  name: notification-service-scaler
  namespace: yeelo-platform
spec:
  scaleTargetRef:
    name: notification-service
  minReplicaCount: 1
  maxReplicaCount: 20
  pollingInterval: 15
  cooldownPeriod: 120
  idleReplicaCount: 0
  
  triggers:
  # Scale based on notification queue in Redis
  - type: redis
    metadata:
      address: redis:6379
      listName: notification_queue
      listLength: '100'
  
  # Scale based on WhatsApp API rate limits
  - type: prometheus
    metadata:
      serverAddress: http://prometheus-kube-prometheus-prometheus.monitoring:9090
      metricName: whatsapp_rate_limit_remaining
      threshold: '1000'
      query: whatsapp_api_rate_limit_remaining
      # Scale up when rate limit is high (more capacity available)
