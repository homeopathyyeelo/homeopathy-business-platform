// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  output   = "../generated/client"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Core User Management
model User {
  id        String   @id @default(cuid())
  email     String   @unique
  phone     String?  @unique
  name      String
  role      UserRole @default(STAFF)
  shopId    String?
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  shop              Shop?              @relation(fields: [shopId], references: [id])
  orders            Order[]
  appointments      Appointment[]
  auditLogs         AuditLog[]
  prescriptions     Prescription[]
  purchaseOrders    PurchaseOrder[]
  invoices          Invoice[]
  payments          Payment[]
  journalEntries    JournalEntry[]
  goodsReceiptNotes GoodsReceiptNote[]

  @@map("users")
}

enum UserRole {
  ADMIN
  DOCTOR
  STAFF
  PATIENT
}

// Shop/Clinic Management
model Shop {
  id          String  @id @default(cuid())
  name        String
  address     String
  phone       String
  email       String?
  isActive    Boolean @default(true)
  workingHours Json?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  users           User[]
  products        Product[]
  inventory       Inventory[]
  orders          Order[]
  purchaseOrders  PurchaseOrder[]
  invoices        Invoice[]

  @@map("shops")
}

// Product Catalog
model Product {
  id          String  @id @default(cuid())
  name        String
  description String?
  price       Decimal @db.Decimal(10, 2)
  imageUrl    String?
  category    String?
  isActive    Boolean @default(true)
  shopId      String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  shop              Shop                @relation(fields: [shopId], references: [id])
  inventory         Inventory[]
  orderItems        OrderItem[]
  purchaseOrderItems PurchaseOrderItem[]
  invoiceItems      InvoiceItem[]

  @@map("products")
}

// Inventory Management
model Inventory {
  id         String    @id @default(cuid())
  productId  String
  shopId     String
  quantity   Int       @default(0)
  batchNo    String?
  expiryDate DateTime?
  reorderLevel Int     @default(10)
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  product Product @relation(fields: [productId], references: [id])
  shop    Shop    @relation(fields: [shopId], references: [id])

  @@unique([productId, shopId, batchNo])
  @@map("inventory")
}

// Customer Management
model Customer {
  id        String   @id @default(cuid())
  name      String
  phone     String   @unique
  email     String?
  address   String?
  dateOfBirth DateTime?
  gender    String?
  marketingConsent Boolean @default(false)
  loyaltyPoints    Int     @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  orders       Order[]
  appointments Appointment[]
  referrals    Referral[]
  invoices     Invoice[]

  @@map("customers")
}

// Orders & Billing
model Order {
  id           String      @id @default(cuid())
  customerId   String
  shopId       String
  userId       String?
  totalAmount  Decimal     @db.Decimal(10, 2)
  status       OrderStatus @default(PENDING)
  orderType    OrderType   @default(WALK_IN)
  paymentStatus PaymentStatus @default(PENDING)
  notes        String?
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt

  customer   Customer    @relation(fields: [customerId], references: [id])
  shop       Shop        @relation(fields: [shopId], references: [id])
  user       User?       @relation(fields: [userId], references: [id])
  orderItems OrderItem[]
  invoices   Invoice[]

  @@map("orders")
}

enum OrderStatus {
  PENDING
  CONFIRMED
  PREPARING
  READY
  DELIVERED
  CANCELLED
}

enum OrderType {
  WALK_IN
  ONLINE
  DELIVERY
  PICKUP
}

enum PaymentStatus {
  PENDING
  PAID
  FAILED
  REFUNDED
}

model OrderItem {
  id        String  @id @default(cuid())
  orderId   String
  productId String
  quantity  Int
  price     Decimal @db.Decimal(10, 2)
  createdAt DateTime @default(now())

  order   Order   @relation(fields: [orderId], references: [id])
  product Product @relation(fields: [productId], references: [id])

  @@map("order_items")
}

// Appointments & Consultations
model Appointment {
  id          String            @id @default(cuid())
  customerId  String
  doctorId    String
  shopId      String?
  scheduledAt DateTime
  duration    Int               @default(30) // minutes
  type        AppointmentType   @default(IN_PERSON)
  status      AppointmentStatus @default(SCHEDULED)
  notes       String?
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt

  customer      Customer       @relation(fields: [customerId], references: [id])
  doctor        User           @relation(fields: [doctorId], references: [id])
  prescriptions Prescription[]

  @@map("appointments")
}

enum AppointmentType {
  IN_PERSON
  VIDEO
  PHONE
}

enum AppointmentStatus {
  SCHEDULED
  CONFIRMED
  IN_PROGRESS
  COMPLETED
  CANCELLED
  NO_SHOW
}

// Prescriptions
model Prescription {
  id            String  @id @default(cuid())
  appointmentId String
  doctorId      String
  notes         String
  medicines     Json?   // Array of medicine details
  instructions  String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  appointment Appointment @relation(fields: [appointmentId], references: [id])
  doctor      User        @relation(fields: [doctorId], references: [id])

  @@map("prescriptions")
}

// Campaign Management
model Campaign {
  id          String         @id @default(cuid())
  name        String
  type        CampaignType
  content     String
  templateId  String?
  scheduledAt DateTime?
  status      CampaignStatus @default(DRAFT)
  targetAudience Json?       // Customer segment criteria
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt

  template Template? @relation(fields: [templateId], references: [id])

  @@map("campaigns")
}

enum CampaignType {
  WHATSAPP
  SMS
  EMAIL
  INSTAGRAM
  GOOGLE_BUSINESS
}

enum CampaignStatus {
  DRAFT
  SCHEDULED
  SENDING
  SENT
  FAILED
}

// Message Templates
model Template {
  id        String       @id @default(cuid())
  name      String
  type      CampaignType
  content   String
  variables Json?        // Template variables
  isActive  Boolean      @default(true)
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt

  campaigns Campaign[]

  @@map("templates")
}

// AI Prompts
model AiPrompt {
  id         String @id @default(cuid())
  name       String
  type       String // social_post, product_description, etc.
  promptText String
  isActive   Boolean @default(true)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@map("ai_prompts")
}

// Coupons & Loyalty
model Coupon {
  id          String     @id @default(cuid())
  code        String     @unique
  type        CouponType @default(PERCENTAGE)
  value       Decimal    @db.Decimal(10, 2)
  minAmount   Decimal?   @db.Decimal(10, 2)
  maxDiscount Decimal?   @db.Decimal(10, 2)
  usageLimit  Int?
  usedCount   Int        @default(0)
  validFrom   DateTime
  validUntil  DateTime
  isActive    Boolean    @default(true)
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  @@map("coupons")
}

enum CouponType {
  PERCENTAGE
  FIXED_AMOUNT
}

// Referral System
model Referral {
  id         String          @id @default(cuid())
  referrerId String
  refereeId  String?
  code       String          @unique
  status     ReferralStatus  @default(PENDING)
  reward     Decimal?        @db.Decimal(10, 2)
  createdAt  DateTime        @default(now())
  updatedAt  DateTime        @updatedAt

  referrer Customer  @relation(fields: [referrerId], references: [id])

  @@map("referrals")
}

enum ReferralStatus {
  PENDING
  COMPLETED
  EXPIRED
}

// Event Sourcing & Outbox Pattern
model Outbox {
  id          String      @id @default(cuid())
  eventType   String
  aggregateId String
  payload     Json
  status      OutboxStatus @default(PENDING)
  retryCount  Int         @default(0)
  createdAt   DateTime    @default(now())
  processedAt DateTime?

  @@map("outbox")
}

enum OutboxStatus {
  PENDING
  PROCESSED
  FAILED
}

model OutboxDlq {
  id          String   @id @default(cuid())
  eventType   String
  aggregateId String
  payload     Json
  error       String
  retryCount  Int
  createdAt   DateTime @default(now())

  @@map("outbox_dlq")
}

// Events for Analytics
model Event {
  id         String   @id @default(cuid())
  type       String
  entityType String
  entityId   String
  userId     String?
  metadata   Json?
  createdAt  DateTime @default(now())

  @@map("events")
}

// Webhook Management
model Webhook {
  id        String        @id @default(cuid())
  url       String
  events    String[]      // Array of event types
  secret    String
  status    WebhookStatus @default(ACTIVE)
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt

  @@map("webhooks")
}

enum WebhookStatus {
  ACTIVE
  INACTIVE
  FAILED
}

// Audit Logs
model AuditLog {
  id         String   @id @default(cuid())
  userId     String
  action     String
  entityType String
  entityId   String
  oldValues  Json?
  newValues  Json?
  ipAddress  String?
  userAgent  String?
  createdAt  DateTime @default(now())

  user User @relation(fields: [userId], references: [id])

  @@map("audit_logs")
}

// Purchase Management
model Vendor {
  id           String   @id @default(cuid())
  name         String
  contactPerson String
  phone        String
  email        String?
  address      String?
  gstNumber    String?
  creditLimit  Decimal? @db.Decimal(10, 2)
  paymentTerms Int?     @default(30) // days
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  purchaseOrders PurchaseOrder[]
  performance   VendorPerformance[]

  @@map("vendors")
}

model PurchaseOrder {
  id                   String   @id @default(cuid())
  vendorId             String
  shopId               String
  poNumber             String   @unique
  status               PurchaseOrderStatus @default(PENDING)
  totalAmount          Decimal  @db.Decimal(10, 2)
  notes                String?
  expectedDeliveryDate DateTime?
  createdBy            String?
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  vendor   Vendor              @relation(fields: [vendorId], references: [id])
  shop     Shop                @relation(fields: [shopId], references: [id])
  createdByUser User?          @relation(fields: [createdBy], references: [id])
  items    PurchaseOrderItem[]
  grn      GoodsReceiptNote?

  @@map("purchase_orders")
}

enum PurchaseOrderStatus {
  PENDING
  APPROVED
  ORDERED
  RECEIVED
  CANCELLED
}

model PurchaseOrderItem {
  id              String    @id @default(cuid())
  purchaseOrderId String
  productId       String
  quantity        Int
  unitPrice       Decimal   @db.Decimal(10, 2)
  batchNo         String?
  expiryDate      DateTime?
  createdAt       DateTime  @default(now())

  purchaseOrder PurchaseOrder @relation(fields: [purchaseOrderId], references: [id], onDelete: Cascade)
  product      Product       @relation(fields: [productId], references: [id])
  grnItems     GrnItem[]

  @@map("purchase_order_items")
}

model GoodsReceiptNote {
  id              String   @id @default(cuid())
  purchaseOrderId String   @unique
  grnNumber       String   @unique
  status          GrnStatus @default(RECEIVED)
  receivedBy      String?
  receivedAt      DateTime @default(now())
  notes           String?
  createdAt       DateTime @default(now())

  purchaseOrder PurchaseOrder @relation(fields: [purchaseOrderId], references: [id])
  receivedByUser User?        @relation(fields: [receivedBy], references: [id])
  items          GrnItem[]

  @@map("goods_receipt_notes")
}

enum GrnStatus {
  RECEIVED
  PARTIAL
  DAMAGED
}

model GrnItem {
  id                   String @id @default(cuid())
  grnId                String
  purchaseOrderItemId  String
  receivedQuantity     Int
  condition            GrnItemCondition @default(GOOD)
  notes                String?
  createdAt            DateTime @default(now())

  grn                GoodsReceiptNote    @relation(fields: [grnId], references: [id], onDelete: Cascade)
  purchaseOrderItem  PurchaseOrderItem  @relation(fields: [purchaseOrderItemId], references: [id])

  @@map("grn_items")
}

enum GrnItemCondition {
  GOOD
  DAMAGED
  EXPIRED
}

model VendorPerformance {
  id            String   @id @default(cuid())
  vendorId      String
  metricName    String
  metricValue   Decimal  @db.Decimal(10, 4)
  measurementDate DateTime @default(now())
  context       Json?

  vendor Vendor @relation(fields: [vendorId], references: [id])

  @@map("vendor_performance")
}

// Finance & Accounting
model Invoice {
  id            String   @id @default(cuid())
  invoiceNumber String   @unique
  customerId    String
  shopId        String
  orderId       String?
  type          InvoiceType
  status        InvoiceStatus @default(DRAFT)
  subtotal      Decimal  @db.Decimal(10, 2)
  taxAmount     Decimal  @db.Decimal(10, 2) @default(0)
  totalAmount   Decimal  @db.Decimal(10, 2)
  notes         String?
  paymentTerms  String?
  dueDate       DateTime?
  createdBy     String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  customer   Customer      @relation(fields: [customerId], references: [id])
  shop       Shop         @relation(fields: [shopId], references: [id])
  order      Order?       @relation(fields: [orderId], references: [id])
  createdByUser User?     @relation(fields: [createdBy], references: [id])
  items      InvoiceItem[]
  payments   Payment[]

  @@map("invoices")
}

enum InvoiceType {
  SALE
  PURCHASE
  SERVICE
  REFUND
}

enum InvoiceStatus {
  DRAFT
  SENT
  PAID
  OVERDUE
  CANCELLED
}

model InvoiceItem {
  id          String  @id @default(cuid())
  invoiceId   String
  productId   String?
  description String
  quantity    Int
  unitPrice   Decimal @db.Decimal(10, 2)
  taxRate     Decimal @db.Decimal(5, 2) @default(0)
  totalAmount Decimal @db.Decimal(10, 2)
  createdAt   DateTime @default(now())

  invoice Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  product Product? @relation(fields: [productId], references: [id])

  @@map("invoice_items")
}

model Payment {
  id            String        @id @default(cuid())
  invoiceId     String
  amount        Decimal       @db.Decimal(10, 2)
  paymentMethod PaymentMethod
  reference     String?
  status        PaymentState @default(COMPLETED)
  processedBy   String?
  processedAt   DateTime      @default(now())
  createdAt     DateTime      @default(now())

  invoice       Invoice @relation(fields: [invoiceId], references: [id])
  processedByUser User? @relation(fields: [processedBy], references: [id])

  @@map("payments")
}

enum PaymentMethod {
  CASH
  CARD
  UPI
  BANK_TRANSFER
  CHEQUE
}

enum PaymentState {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
}

model ChartOfAccount {
  id              String   @id @default(cuid())
  accountCode     String   @unique
  accountName     String
  accountType     AccountType
  parentAccountId String?
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())

  parentAccount ChartOfAccount?  @relation("AccountHierarchy", fields: [parentAccountId], references: [id])
  subAccounts   ChartOfAccount[] @relation("AccountHierarchy")
  journalLines  JournalEntryLine[]

  @@map("chart_of_accounts")
}

enum AccountType {
  ASSET
  LIABILITY
  EQUITY
  REVENUE
  EXPENSE
}

model JournalEntry {
  id          String   @id @default(cuid())
  entryNumber String   @unique
  description String
  entryDate   DateTime
  totalDebit  Decimal  @db.Decimal(10, 2)
  totalCredit Decimal  @db.Decimal(10, 2)
  createdBy   String?
  createdAt   DateTime @default(now())

  createdByUser User?           @relation(fields: [createdBy], references: [id])
  lines         JournalEntryLine[]

  @@map("journal_entries")
}

model JournalEntryLine {
  id             String  @id @default(cuid())
  journalEntryId String
  accountId      String
  debitAmount    Decimal @db.Decimal(10, 2) @default(0)
  creditAmount   Decimal @db.Decimal(10, 2) @default(0)
  description    String?
  createdAt      DateTime @default(now())

  journalEntry JournalEntry    @relation(fields: [journalEntryId], references: [id], onDelete: Cascade)
  account     ChartOfAccount  @relation(fields: [accountId], references: [id])

  @@map("journal_entry_lines")
}

model CurrencyRate {
  id            String   @id @default(cuid())
  fromCurrency  String
  toCurrency    String
  exchangeRate  Decimal  @db.Decimal(10, 6)
  effectiveDate DateTime
  createdAt     DateTime @default(now())

  @@map("currency_rates")
}
